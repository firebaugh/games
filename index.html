<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Expeditions: USC Space Games</title>
        <script type="text/javascript" src="http://cdn.jsdelivr.net/phaser/2.5.0/phaser.min.js"></script>
        <script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
        <script type="text/javascript" src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
       
        <script type="text/javascript" src="SARGame.js"></script>

        <style>
        body{
            width: 100%;
            height: 100%;
            padding: 0px;
            margin: 0px;
        }
        </style>

    </head>

    <body>

    <script type="text/javascript">
    
    var url = 'ws://localhost:9090';

    window.onload = function() {

        var loading = true;
        var game = new SpaceGame(url);
        var activities = {};
        
        var ros = new ROSLIB.Ros({
            url : url
	});
        
        var game_command = new ROSLIB.Topic({
            ros : ros,
            name : '/sar/game_command',
            messageType : 'sar_game_command_msgs/GameCommand' 
        });

        game_command.subscribe( message => {
                switch(message.command){
                
                case GameCommands.START:
                    console.log('Received game START message for ' + 
                        Object.getOwnPropertyNames(Games)[message.game]);
                    
                    // If loading, then start game
                    if (loading) {
                        switch(message.game) {
                        
                        case Games.GALACTIC_TRAVELER:
                            loading = false;
                            if (Object.keys(activities).length < 1) {
                                activities = genGalacticTraveler(message.level);
                                game.end();
                                game = new Activity1(url, activities["Activity1"]);
                                //delete activities["Activity1"];
                            }
                            // still playing
                            else {
                                console.log('FAILED TO START Galactic Traveler game. Already playing!')
                            }
                        break;
                        
                        case Games.SPACESHIP_TIDYUP:
                            loading = false;
                            game.end();
                            if (activities.length < 1) {
                                activities = genSpaceshipTidyUp(message.level);
                                game.end();
                                game = new Activity6(url, activities["Activity6"]);
                                //delete activities["Activity6"];
                            }
                            // still playing
                            else {
                                console.log('FAILED TO START Spaceship Tidy-Up game. Already playing!')
                            }
                        break;
                        
                        case Games.ALIEN_CODES:
                            loading = false;
                            game.end();
                            // TODO implement Alien Codes class
                        break;
                         
                        default:
                        break; 
                        } 
                    }
                break;

                case GameCommands.END:
                    console.log('Received game END message for ' + 
                        Object.getOwnPropertyNames(Games)[message.game]);
                    
                    switch(message.game) {
                    
                    case Games.GALACTIC_TRAVELER:
                    case Games.SPACESHIP_TIDYUP:
                    case Games.ALIEN_CODES:
                        // load new space game
                        loading = true;
                        game.end();
                        game = new SpaceGame(url);
                    break;
                         
                    default:
                    break; 
                    } 
                break;
                
                default:
                break;
            }
        });

        /* Robot States
        this.Games = Object.freeze({STORYTELLING:0, ROCKET_BARRIER:1, OUTERSPACE:2});
        this.GameCommands = Object.freeze({START:0, CONTINUE:1, PAUSE:2, END:3, WAIT_FOR_RESPONSE:4, SKIP_RESPONSE:5});
        this.robot_state_msg = null;
        
        this.robot_state = new ROSLIB.Topic({
            ros : this.ros,
            name : '/sar/robot_state',
            messageType : 'sar_robot_state_msgs/GameCommand' 
        });

        this.game_command.subscribe( function(message) {
            console.log('Received COMMAND=' + message.command + ' for GAME=' + message.game);
            this.game_command_msg = message;
        });*/
 

        // PUBLISHERS
        // Game States
        var game_state = new ROSLIB.Topic({
            ros : ros,
            name : '/sar/game_state',
            messageType : 'sar_game_command_msgs/GameState' 
        });
        // Robot Commands
        var robot_command = new ROSLIB.Topic({
            ros : ros,
            name : '/sar/robot_command',
            messageType : 'sar_robot_command_msgs/RobotCommand' 
        });


        // ROS CONNECTION INFO
        ros.on('connection', function() {
            console.log('Connected to websocket server.');
        });
        ros.on('error', function(error) {
            console.log('Error connecting to websocket server: ', error);
        });
        ros.on('close', function() {
            console.log('Connection to websocket server closed.');
        });


        var random_level = min => { return Math.random() * 2 + min; };
        
        /* 
         * Galactic Traveler
         * -----------------
         */
        function genGalacticTraveler(level) {
            switch(level){
                case 1:
                    return {
                        "Activity1": random_level(1),
                        "Activity2": random_level(1),
                        "Activity3": 5,
                        "Activity4": random_level(1),
                        "Activity5": 2
                    };
                case 2:
                    return {
                        "Activity1": random_level(4),
                        "Activity2": random_level(4),
                        "Activity3": 3,
                        "Activity4": random_level(4),
                        "Activity5": 4
                    };
                case 3:
                     return {
                        "Activity1": random_level(7),
                        "Activity2": random_level(7),
                        "Activity3": 1,
                        "Activity4": random_level(7),
                        "Activity5": 6
                    };
                default:
                    console.log(this.level+" invalid level for Galactic Traveler. Choose from levels 1-3.");
                    return {};
            }
        }

        /*
         * Spaceship Tidy-Up
         * -----------------
         */
        function genSpaceshipTidyUp(level) {
            switch(level){
                case 1:
                    return {
                        "Activity6": random_level(1),
                        "Activity7": 1,
                        "Activity8": 1,
                        "Activity9": 1,
                        "Activity10": 1
                    };
                case 2:
                    return {
                        "Activity6": random_level(4),
                        "Activity7": 2,
                        "Activity8": 2,
                        "Activity9": 2,
                        "Activity10": 2
                    };
                case 3:
                     return {
                        "Activity6": random_level(7),
                        "Activity7": 3,
                        "Activity8": 3,
                        "Activity9": 3,
                        "Activity10": 3
                    };
                default:
                    console.log(this.level+" invalid level for Spaceship Tidy-Up. Choose from levels 1-3.");
                    return {};
            }
        }
    };

    </script>

    </body>
</html>
